<!DOCTYPE html>
<html>
<head>
  <title>Live Auctions</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% include 'bidder_nav.html' %}
  <div class="content">
    <h2>Live Auctions</h2>
    
    
    <div class="product-grid">
      {% if products %}
        {% for product in products %}
        <div class="product-card">
          {% if product.image_url %}
          <div class="product-image">
            <img src="{{ url_for('static', filename=product.image_url) }}" alt="{{ product.name }}">
          </div>
          {% else %}
          <div class="product-image no-image"><span>No Image</span></div>
          {% endif %}
          <div class="product-details">
            <h3>{{ product.name }}</h3>
            <p class="product-price">Starting Bid: {{ format_indian_currency(product.starting_bid) }}</p>
            <p class="product-category">{{ product.category.name }} > {{ product.subcategory.name }}</p>
            <p class="product-seller">Seller: {{ product.seller.username }}</p>
            <div class="status-badge live">Live</div>
            <a href="/auction/{{ product.auctions[0].id }}" class="btn view-btn">View Auction</a>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="no-products">No live auctions.</p>
      {% endif %}
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeModal('loginModal')">&times;</span>
          <h2 class="modal-title">Login</h2>
          <form id="loginForm" onsubmit="handleLogin(event)">
              <div class="form-group">
                  <label for="login-username">Email or Username</label>
                  <input type="text" id="login-username" name="username" required>
              </div>
              <div class="form-group">
                  <label for="login-password">Password</label>
                  <input type="password" id="login-password" name="password" required>
              </div>
              <button type="submit" class="btn">Login</button>
          </form>
      </div>
  </div>

  <!-- Signup Modal -->
  <div id="signupModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeModal('signupModal')">&times;</span>
          <h2 class="modal-title">Sign Up</h2>
          <form id="signupForm" onsubmit="handleSignup(event)">
              <div class="form-group">
                  <label for="signup-role">Role</label>
                  <select id="signup-role" name="role" required>
                      <option value="">Select Role</option>
                      <option value="bidder">Bidder</option>
                      <option value="seller">Seller</option>
                  </select>
              </div>
              <div class="form-group">
                  <label for="signup-username">Username</label>
                  <input type="text" id="signup-username" name="username" required>
              </div>
              <div class="form-group">
                  <label for="signup-email">Email</label>
                  <input type="email" id="signup-email" name="email" required>
              </div>
              
              <div class="form-group">
                  <label for="signup-password">Password</label>
                  <input type="password" id="signup-password" name="password" required>
              </div>
              <div class="form-group">
                  <label for="signup-confirm-password">Confirm Password</label>
                  <input type="password" id="signup-confirm-password" name="confirm_password" required>
              </div>
              <button type="submit" class="btn">Sign Up</button>
          </form>
      </div>
  </div>

  <script>
      // Login Modal Functions
      function openModal(modalId) {
          document.getElementById(modalId).style.display = 'block';
      }
      
      function closeModal(modalId) {
          document.getElementById(modalId).style.display = 'none';
      }
      
      // Close modal when clicking outside of it
      window.onclick = function(event) {
          if (event.target.classList.contains('modal')) {
              event.target.style.display = 'none';
          }
      }

      // Handle Login
      async function handleLogin(event) {
          event.preventDefault();
          const form = event.target;
          const formData = new FormData(form);

          try {
              const response = await fetch('/api/login', {
                  method: 'POST',
                  body: formData
              });
              const data = await response.json();
              
              if (data.success) {
                  // Redirect to the appropriate dashboard
                  alert('Login successful!');
                  closeModal('loginModal');
                  window.location.href = data.redirect;
                  form.reset();
              } else {
                  alert(data.message || 'Login failed!');
              }
          } catch (error) {
              alert('Error occurred during login');
              console.error('Login error:', error);
          }
      }

      // Handle Signup
      async function handleSignup(event) {
          event.preventDefault();
          const form = event.target;
          const formData = new FormData(form);

          // Password confirmation
          const password = document.getElementById('signup-password').value;
          const confirmPassword = document.getElementById('signup-confirm-password').value;
          
          if (password !== confirmPassword) {
              alert("Passwords do not match!");
              return;
          }

          try {
              const response = await fetch('/api/signup', {
                  method: 'POST',
                  body: formData
              });
              const data = await response.json();
              
              if (data.success) {
                  alert(data.message);
                  closeModal('signupModal');
                  form.reset();
                  // Open login modal after successful registration
                  openModal('loginModal');
              } else {
                  alert(data.message || 'Signup failed!');
              }
          } catch (error) {
              alert('Error occurred during signup. Please try again.');
              console.error('Signup error:', error);
          }
      }
  </script>
</body>
</html>
